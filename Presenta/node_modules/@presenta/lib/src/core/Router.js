
import { controllers } from '../controllers/types.js'
import u from '../utils.js'
import css from './css/router.css'

const Router = function (rootElement, projectConfig) {
  const child = u.div(`<div class="controller ${css.router}"></div>`)
  rootElement.appendChild(child)

  const scenes = projectConfig.scenes
  const numScenes = () => scenes.length - 1
  const listeners = {}
  const registeredIO = {}

  let currentIndex = 0
  let currentStep = 0
  let numSteps = 0

  const setNumSteps = () => {
    numSteps = scenes[currentIndex] &&
        scenes[currentIndex]._steps
      ? scenes[currentIndex]._steps.length
      : 0
  }
  // setNumSteps()

  const updateRouterWrapper = () => {
    const sceneConfig = scenes[currentIndex]

    child.classList.remove(...child.classList)
    child.classList.add('controller', css.router)
    child.style = null
    u.globs(child, sceneConfig)
    u.props(child, sceneConfig)
  }

  this.next = () => {
    if (currentStep === numSteps) {
      this.nextIndex()
    } else {
      currentStep++
      this.notify('stepChanged')
    }
  }
  this.prev = () => {
    this.prevIndex()
  }

  this.nextIndex = () => {
    if (currentIndex < numScenes()) {
      currentIndex++
      currentStep = 0
      this.notify(['nextIndex', 'indexChanged'])
    } else {
      currentIndex = numScenes()
      currentStep = 0
      this.notify('end')
    }
    setNumSteps()
  }
  this.prevIndex = () => {
    if (currentIndex > 0) {
      currentIndex--
      currentStep = 0
      this.notify(['prevIndex', 'indexChanged'])
    } else {
      currentIndex = 0
      currentStep = 0
      this.notify('begin')
    }
    setNumSteps()
  }

  this.goto = v => {
    currentIndex = v < numScenes() ? v : numScenes()
    currentStep = 0
    this.notify(['nextIndex', 'indexChanged'])
  }

  this.notify = evt => {
    const evts = Array.isArray(evt) ? evt : [evt]

    evts.forEach(ev => {
      if (ev === 'indexChanged') updateRouterWrapper()

      if (listeners[ev]) {
        listeners[ev].forEach(clb => {
          clb({
            currentIndex,
            currentStep,
            totalScenes: this.totalScenes(),
            totalSteps: numSteps,
            isFirst: this.isFirst(),
            isLast: this.isLast()
          })
        })
      }
    })
  }

  this.on = (evt, clb) => {
    if (!listeners[evt]) {
      listeners[evt] = []
    }
    listeners[evt].push(clb)
  }

  this.off = (evt, clb) => {
    const index = listeners[evt].indexOf(clb)
    if (index >= 0) listeners[evt].splice(index, 1)
  }

  this.totalScenes = () => numScenes() + 1
  this.totalSteps = () => numSteps
  this.currentIndex = () => currentIndex
  this.currentStep = () => currentStep
  this.isFirst = () => currentIndex === 0
  this.isLast = () => currentIndex === numScenes()
  this.setCurrentIndex = idx => (currentIndex = idx)
  this.setCurrentStep = stp => (currentStep = stp)
  this.controllers = registeredIO

  if (projectConfig.controllers) {
    for (const k in projectConfig.controllers) {
      const modConfig = projectConfig.controllers[k]
      const Mod = controllers[k]
      if (!Mod) console.log(`Controller "${k}" not found. Maybe you forgot to include it.`)
      if (modConfig && Mod) {
        registeredIO[k] = new Mod(child, this, modConfig, projectConfig)
      }
    }
  }

  this.notify('indexChanged')

  setTimeout(() => {
    this.notify('init')
    setNumSteps()
  })
}

export { Router }
